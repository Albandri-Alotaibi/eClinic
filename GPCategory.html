<!DOCTYPE html>
<html class="eClinic" lang="en">

<head>
  <link rel="stylesheet" href="index.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
  <link href='https://fonts.googleapis.com/css?family=Oswald:300' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Familjen Grotesk' rel='stylesheet'>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link id="theme-style" rel="stylesheet" href="semester.css">
  <!-- MDB -->
  <!-- <link rel="stylesheet" href="css/mdb.min.css" /> -->
  <!-- for the logos in the sidebar -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <title>Graduation Project Category</title>
  <!--********************************************* STYLE THE TABLE**************************************************** -->
</head>

<body>

  <!-- ********************* RETRIEVE ********************************************************* -->

  <body class="site">
    <main>
      <div class="conterer">

        <!-- Start profil icons  -->
        <div class="action" style="z-index: 99999; font-size: 14px;">
          <div class=" profile" onclick="menuToggle();">

            <img src="img/user.png" />

          </div>

          <div class="menu">

            <ul>

              <li>

                <img src="img/logout.png" /><a href="#" class="logout">Log Out</a>

              </li>

              <li>

                <img src="img/lock.png" /><a href="resetinner.html">Reset Password</a>

              </li>

            </ul>

          </div>

        </div>
        <!-- end profil icons  -->





        <!-- ********************* RETRIEVE ********************************************************* -->

        <div class="row" style="margin-top: 1.5%;">
          <!-- class="active_semester" -->
          <!-- side menu -->
          <div class="col-md-3" style="display: block; ">
            <nav class="sidebar ">
              <img class="logo" src="img/logo.png" alt="logo brand" height="10%" width="50%">
              <a href="index.html" accesskey="h"><i class="fa fa-fw fa-home"></i>Home</a>
              <a href="semesters.html" accesskey="s"><i class="fa fa-calendar"></i> Semesters</a>
              <a href="faculty.html" accesskey="f"><i class="fa fa-group"></i> Faculty Members Speciality </a>
              <a href="GPCategory.html" accesskey="g"class="active_semester"><i class="fa fa-graduation-cap"></i> Graduation Projects
                Category
              </a>
              <a href="timeframe.html" accesskey="p"><i class="fa fa-clock-o"></i> Help Desk Dates</a>
              <footer class="footer_eClinic">
                <p class="text-white text-justify position-absolute bottom-0 display-10"> Copyright &copy; All
                  Rights
                  Reserved to
                  King Saud University.Made by eClinic Teams</p>
              </footer>
            </nav>
          </div>


          <!-- side menu -->

          <!-- left side -->
          <div class="col mt-5 card p-2 " style="display: block; ">
            <div class="d-flex justify-content-end">
              <input type="button" value="Add New GP Category" id="add" class=" logbut btn btn-primary btn-lg"
                style="padding-left: 0.5rem; padding-right: 0.5rem; padding-bottom: 0.2rem; padding-top: 0.2rem; font-size: 18px;">
            </div><br>
            <h4 class="">Graduation Projects Category</h4>

            <div style="display: none;" class="card border-warning mt-5 m-3 p-2 text-bg-warning" id="noItems">
              There is curretnly no GP categoryy.
            </div>
            <table class="show_info card-body table" style="width:100%; display: none;" id="mytable">

              <thead>
                <th style="width:80%"> GP Category</th>
                <th style="width:10%"></th>
              </thead>
              <tbody id="show_data">

              </tbody>
            </table>
          </div>
          <!-- left side -->


          <!-- right form -->
          <div class="col-md-3 ms-auto mt-5 card">
            <div style="display: none;" class="card border-success mt-5 m-3 p-2 text-success" id="message"></div>
            <form class="col" id="fa-text" style="display: none;">
              <div class="my-3">

                <label class="form-label" style="font-size:16px;"> GP Category Name :</label>
                <input id="inputfield" class="form-control" type="text" placeholder="Enter Category">
              </div>


              <div class="d-flex justify-content-evenly">
                <input type="button" value="Add" id="addtodb" class="mt-3 logbut btn btn-primary btn-lg"
                  style="padding-left: 1.2rem; padding-right: 1.4rem; padding-bottom: 0.2rem; padding-top: 0.2rem; font-size: 18px;"
                  style="display: none;">
                <input type="button" value="Update" id="updatebotn" class="mt-3 logbut btn btn-primary btn-lg"
                  style="padding-left: 0.5rem; padding-right: 0.5rem; padding-bottom: 0.2rem; padding-top: 0.2rem; font-size: 18px;"
                  style="display: none; ">
                <input type="button" value="Cancle" id="cancle" class="mt-3 btn btn-secondary" style="display: none; ">
              </div>
            </form>
          </div>
          <!-- End right form -->
        </div>
      </div>
    </main>
    <!-- ********************* END front end ********************************************************* -->






    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-app.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries
      import { getFirestore, doc, collection, query, where, getDocs, getDoc, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-firestore.js";
      import { getAuth, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-auth.js"; //import for authentication +signout
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyD6JcSscRU6XaF3SaCF_U3ggXAFYUnKKq8",
        authDomain: "eclinic-d5dec.firebaseapp.com",
        projectId: "eclinic-d5dec",
        storageBucket: "eclinic-d5dec.appspot.com",
        messagingSenderId: "148819771062",
        appId: "1:148819771062:web:44c6a3f963095275247017"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore();
      const auth = getAuth()


      //alert(/^[`!@#$%^&*()_+\-=\[\]{};':"\\|,.< >\/?~\d]*$/g.test(" *"));
      // alert( /^\d+$/.test(" 3"));
      setTimeout(() => {
        if (document.getElementById("noItems").style.display == "none")
          document.getElementById("mytable").style.display = "block";
      }, 2000);


      // *********************************INITIALIZE ALL VARIBALES*********************************************
      document.onreadystatechange = async function () {

        let newaddbtn = document.getElementById("add");
        let addbtn = document.getElementById("addtodb");
        let editbtn = document.getElementsByClassName("update");
        let updatebtn = document.getElementById("updatebotn");
        let divtext = document.getElementById("fa-text");
        let canclebtn = document.getElementById("cancle");

        let hasNoItems = true;

        //********************* RETREIVING ALL CATEGORIES FROM DATABASE *****************************************************

        let box = document.getElementById("show_data");
        const q = query(collection(db, "gpcategory"));
        const querySnapshot = await getDocs(q);
        querySnapshot.forEach((doc) => {
          hasNoItems = false;
          box.innerHTML += '<tr >' + '<td><span id="' + doc.id + '">' + doc.data().gpcategoryname + '</span></td>'
            + '<td>' +
            '<input type="button" value="✎" class="update logbut btn btn-primary btn-lg" style="padding-left: 0.5rem; padding-right: 0.5rem; padding-bottom: 0.2rem; padding-top: 0.2rem; font-size: 18px; left:100%;" data-ref="' + doc.id + '">' +
            '</td>' + '</tr>';

        });

        hasItemsCheck();
        // *********************************FOR CLEAR TEXT BOX WHEN WE WANT TO (ADD NEW GP Category)****************  
        const resetForm = () => {
          inputfield.value = ""

        }


        // *********************************for yallow alert*********************************************


        function hasItemsCheck() {
          if (hasNoItems) {
            document.getElementById('noItems').style.display = 'block';
            document.getElementById('mytable').style.display = 'none';
          } else {
            document.getElementById('mytable').style.display = 'block';
            document.getElementById('noItems').style.display = 'none';
          }
        }

        // *********************************when click add new GP category button *********************************************
        newaddbtn.addEventListener('click', function () {
          resetForm();
          newaddbtn.style.display = "block";
          addbtn.style.display = "block";
          // editbtn.style.display = "block";
          updatebtn.style.display = "none";
          divtext.style.display = "block";
          canclebtn.style.display = "block";
        });

        // *********************************cancle btn*********************************************************************************

        canclebtn.addEventListener('click', function () {
          {
            if (confirm("Are you sure to want to cancle your work?") == true) {
              divtext.style.display = "none";
              resetForm();
            }
            else
              return false;

          }
        })



        // *********************************for green alert*********************************************
        function successMessage(message) {
          document.getElementById('message').innerHTML = message;
          document.getElementById('message').style.display = "block";

          setTimeout(() => {
            var elems = document.querySelectorAll("tr.table-success");

            [].forEach.call(elems, function (el) {
              el.classList.remove("table-success");
            });
            document.getElementById('message').style.display = "none";
          }, 5000);
        }
        ////////////////////////********************* METHOD FOUND SEARCH ************************************************************
        const docExistsOrNot = async (GPCategoryenteredname) => {
          var found = false;
          let BVnospace = GPCategoryenteredname.split(" ").join("");
          let BVnospaselowercase = BVnospace.toLowerCase();
          const qadd = query(collection(db, "gpcategory"));
          const querySnapshotadd = await getDocs(qadd);
          querySnapshotadd.forEach((doc) => {

            let dbname = doc.data().gpcategoryname;
            let dbnamenospace = dbname.split(" ").join("");
            let dbnamenospacelowercase = dbnamenospace.toLowerCase();
            if (BVnospaselowercase == dbnamenospacelowercase) {
              found = true;
            }
          });
          return found;
        }




        //********************* ADD TO DATABASE *****************************************************

        var inputfield = document.getElementById("inputfield");

        addbtn.addEventListener("click", async function () {
          let BV = inputfield.value;
          if (BV == "" || BV == null) {
            alert("Please fill in the GP category name");
            return;
          } else if (/[\u0600-\u06FF\u0750-\u077F]/.test(BV)) {
            alert("Only English is allowed");
            return;
          } else if (/^\d+$/.test(BV)) {
            alert("GP category name cannot contain only digits");
            return;
          } else if (/^[^a-zA-Z0-9]+$/.test(BV)) {
            alert("GP category name cannot contain only special characters");
            return;
          } else if (/^[`!@#$%^&*()_+\-=\[\]{};':"\\|,.< >\/?~\d]*$/g.test(BV)) {
            alert("GP category name cannot contain only digits and special characters");
            return;
          }
          addbtn.setAttribute("disabled","disabled");
          let found = await docExistsOrNot(BV);
          if (found == true) {
            alert("this GP category is already added");
          } else {
            var ref = collection(db, "gpcategory");
            const docRef = await addDoc(
              ref, {
              gpcategoryname: BV
            });

            box.innerHTML += '<tr class="table-success">' + '<td><span id="' + docRef.id + '">' + BV + '</span></td>'
              + '<td>' +
              '<input type="button" value="✎" class="update logbut btn btn-primary btn-lg" style="padding-left: 0.5rem; padding-right: 0.5rem; padding-bottom: 0.2rem; padding-top: 0.2rem; font-size: 18px; left:100%;" data-ref="' + docRef.id + '">' +
              '</td>' + '</tr>';

            hasNoItems = false;
            hasItemsCheck();
            successMessage("GP category has been added successfully");

            addUpdateEvents();
            divtext.style.display = "none";
          }
          addbtn.removeAttribute("disabled");
        });
        // ******************************************YOUR CODE (YOU can remove it)************************************************
        // addbtn.addEventListener("click",AddDocument_AutoID);    
        var StoringInputFliedValueToCompareIfItsChanngedWhenClickingUpdateButton = "";
        //********************************** UPDATE DATABASE ****************************************************************
        const addUpdateEvents = () => {

          for (var i = 0; i < editbtn.length; i++) {
            editbtn.item(i).addEventListener('click', async function (event) {

              newaddbtn.style.display = "block";
              addbtn.style.display = "none";
              // editbtn.style.display = "block";
              updatebtn.style.display = "block";
              divtext.style.display = "block";
              canclebtn.style.display = "block";


              // ********************************HOW I CAN RETRIVE DATA IN TEXT BOX TO UPDATE IT ? *********************************



              var categoryid = event.target.getAttribute('data-ref');
              let inputfield = document.getElementById("inputfield");
              const docRef = doc(db, "gpcategory", categoryid);
              const docSnap = await getDoc(docRef);
              if (docSnap.exists()) {
                updatebtn.setAttribute('data-ref', categoryid);
                inputfield.value = docSnap.data().gpcategoryname;
                StoringInputFliedValueToCompareIfItsChanngedWhenClickingUpdateButton = docSnap.data().gpcategoryname;
              } else {
                // doc.data() will be undefined in this case
                console.log("No such document!");
              }


            })
          }
        };

        addUpdateEvents();
        // ********************************when click update btn *********************************
        updatebtn.addEventListener('click', async function () {
          let inputfield = document.getElementById("inputfield");
          var categoryid = updatebtn.getAttribute('data-ref');
          //alert(categoryid);


          let BV2 = inputfield.value;
          if (BV2 == "" || BV2 == null) {
            alert("Please fill in the GP category name");
            return;
          } else if (/[\u0600-\u06FF\u0750-\u077F]/.test(BV2)) {
            alert("Only English is allowed");
            return;
          } else if (/^\d+$/.test(BV2)) {
            alert("GP category name cannot contain only digits");
            return;
          } else if (/^[^a-zA-Z0-9]+$/.test(BV2)) {
            alert("GP category name cannot contain only special characters");
            return;
          } else if (/^[`!@#$%^&*()_+\-=\[\]{};':"\\|,.< >\/?~\d]*$/g.test(BV2)) {
            alert("GP category name cannot contain only digits and special characters");
            return;
          } else if (StoringInputFliedValueToCompareIfItsChanngedWhenClickingUpdateButton == BV2) {//if its exactly the same with capital and small and space layout(it will NOT be updated)
            alert("You did not change the GP category name");
            return;
          } else if (StoringInputFliedValueToCompareIfItsChanngedWhenClickingUpdateButton.split(" ").join("").toLowerCase() == BV2.split(" ").join("").toLowerCase()) {//if its the same with different capital or small or space layout(it will be updated)
            try {
              var ref = doc(db, "gpcategory", categoryid);
              await updateDoc(
                ref, {
                gpcategoryname: BV2
              })

            } catch (e) {
              //in case there is an error! we dont update the page.
              alert('We caught an error during update, refresh the page and try again!');
              return;
            }

            //updatepage
            document.getElementById(categoryid).innerHTML = BV2;
            divtext.style.display = "none";
            successMessage("GP category has been updated successfully");
            document.getElementById(categoryid).parentNode.parentElement.classList.add('table-success');
            return;
          }//end else if its the same with different capital and small and space layout(it will be updated)


          updatebtn.setAttribute("disabled","disabled");
          //Checking if its already in the database
          let found = await docExistsOrNot(BV2);
          if (found == true) {
            alert("This GP category is already added");
          } else {
            try {
              var ref = doc(db, "gpcategory", categoryid);
              await updateDoc(
                ref, {
                gpcategoryname: BV2
              })

            } catch (e) {
              //in case there is an error! we dont update the page.
              alert('We caught an error during update, refresh the page and try again!');
              return;
            }

            //updatepage
            document.getElementById(categoryid).innerHTML = BV2;
            divtext.style.display = "none";
            successMessage("GP category has been updated successfully");
            document.getElementById(categoryid).parentNode.parentElement.classList.add('table-success');
          }
          updatebtn.removeAttribute("disabled");
        });


        const samevalue = async (categoryid, BV2) => {
          var same = false;
          const docRef = doc(db, "gpcategory", categoryid);
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
            same = true;
          }
          return same;
        }



      }//end all js

      ////////////////////////////////////////logout/////////////////////////////////
      const logout = document.querySelector('.logout')
      logout.addEventListener("click", () => {
        const conf = confirm("Are you sure you want to log out?")

        if (conf === true) {
          signOut(auth)
            .then(() => {
              console.log("user log out")
            })
            .catch((err) => {
              console.log(err.message)
            })

          window.location.replace("login.html")
        }


      });

      /////////////////////////there is authentication for each page  /////////////////////////
      onAuthStateChanged(auth, (user) => {
        if (user) {
          // console.log("the same user")

        }
        else {
          signOut(auth)
          window.location.replace("login.html")
            .then(() => {
              console.log("user log out")
            })
            .catch((err) => {
              console.log(err.message)
            })
        }
        console.log("the user status change :", user)
      })


    </script>


    <script>
      // start: java sript for profile icons 
      function menuToggle() {
        const toggleMenu = document.querySelector(".menu");
        toggleMenu.classList.toggle("active");
      }
      // End: java sript for profile icons
    </script>



  </body>

</html>