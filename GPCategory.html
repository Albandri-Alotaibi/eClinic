<!DOCTYPE html>
<html class="eClinic" lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title class="homepage">GP Category</title>
   

    <style>
      td,
      th {
  
        padding: 8px;
      }
  
  
      th {
        padding-top: 12px;
        padding-bottom: 12px;
        text-align: left;
        background-color: #0084BD;
        color: white;
      }
    </style>
</head>

<body>

<!-- ********************* RETRIEVE ********************************************************* -->

<div class="box1_Albandri">
  <input type="button" value="Add new GP Category" id="add">
  <table class="show_info">

    <thead>
      <th> GP Category</th>
      <th></th>
    </thead>
    <tbody id="show_data">

    </tbody>

  </table>
</div><br> <br>

<!-- ********************* END RETRIEVE ********************************************************* -->



<!-- ********************* START section to be hidden ********************************************************* -->

          
         <div id="fa-text" style="display: none;">
          <label> category :</label>
              <input id ="inputfield" type="text"> 
          <input type="button" value="Add" id="addtodb" style="display: none;">
         <input type="button" value="update" id="updatebotn" style="display: none; " >
         <input type="button" value="cancle" id="cancle" style="display: none; ">
</div>
      
<!-- ********************* END section to be hidden ********************************************************* -->






    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
        import { getFirestore, doc, collection, query, where, getDocs, getDoc, addDoc, updateDoc} from "https://www.gstatic.com/firebasejs/9.12.1/firebase-firestore.js";
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyD6JcSscRU6XaF3SaCF_U3ggXAFYUnKKq8",
          authDomain: "eclinic-d5dec.firebaseapp.com",
          projectId: "eclinic-d5dec",
          storageBucket: "eclinic-d5dec.appspot.com",
          messagingSenderId: "148819771062",
          appId: "1:148819771062:web:44c6a3f963095275247017"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore();

        
      //alert(/^[`!@#$%^&*()_+\-=\[\]{};':"\\|,.< >\/?~\d]*$/g.test(" *"));
     // alert( /^\d+$/.test(" 3"));



      document.onreadystatechange = async function () {
         
 

//********************* RETREIVING ALL CATEGORIES FROM DATABASE *****************************************************

let box = document.getElementById("show_data");
const q = query(collection(db, "gpcategory"));
      const querySnapshot = await getDocs(q);
querySnapshot.forEach((doc) => {
  box.innerHTML += '<tr>' + '<td><span id="' + doc.id + '">' + doc.data().gpcategoryname + '</span></td>' 
          +'<td>' +
          '<input type="button" value="edit" class="update" data-ref="' + doc.id + '">' +
          '</td>' + '</tr>';

});
 // *********************************FOR CLEAR TEXT BOX WHEN WE WANT TO (ADD NEW GP Category)****************  
const resetForm = () => {
  inputfield.value = ""
       
      }

 // *********************************INITIALIZE ALL VARIBALES*********************************************
      let newaddbtn = document.getElementById("add");
      let addbtn = document.getElementById("addtodb");
      let editbtn = document.getElementsByClassName("update");
      let updatebtn = document.getElementById("updatebotn");
      let divtext = document.getElementById("fa-text");
      let canclebtn = document.getElementById("cancle");

     
      newaddbtn.addEventListener('click', function () {
        resetForm();
      newaddbtn.style.display = "block";
      addbtn.style.display = "block";
      // editbtn.style.display = "block";
      updatebtn.style.display = "none";
      divtext.style.display = "block";
      canclebtn.style.display = "block";
      });

// *********************************cancle btn*********************************************************************************
      canclebtn.addEventListener('click', function () {
        alert('are you sure? You will lose your edits');
        divtext.style.display = "none";
        resetForm();
      })
////////////////////////********************* METHOD FOUND SEARCH ************************************************************
const docExistsOrNot = async (GPCategoryenteredname) => {
         var found = false;
        let BVnospace=GPCategoryenteredname.split(" ").join("");
        let BVnospaselowercase= BVnospace.toLowerCase();
        const qadd = query(collection(db, "gpcategory"));
        const querySnapshotadd = await getDocs(qadd);
        querySnapshotadd.forEach((doc) => {
          let dbname=doc.data().gpcategoryname;
          let dbnamenospace= dbname.split(" ").join("");
          let dbnamenospacelowercase=dbnamenospace.toLowerCase();
          if(BVnospaselowercase==dbnamenospacelowercase){
                        found=true;
                     }
        });
        return found;
      }




//********************* ADD TO DATABASE *****************************************************

var inputfield= document.getElementById("inputfield");      

addbtn.addEventListener("click",async function (){ 
                 let BV = inputfield.value;
                if(BV=="" || BV==null){
                 alert("Please fill in the GP category name");
                 return;
                }else if(/[\u0600-\u06FF\u0750-\u077F]/.test(BV)){
                    alert("Only English is allowed");
                    return;
                }else if(/^\d+$/.test(BV)){
                    alert("GP category name cannot contain only digits");
                    return;
                   }else if(/^[^a-zA-Z0-9]+$/.test(BV)){
                    alert("GP category name cannot contain only special characters");
                    return;
                   }else if(/^[`!@#$%^&*()_+\-=\[\]{};':"\\|,.< >\/?~\d]*$/g.test(BV)){
                    alert("GP category name cannot contain only digits and special characters");
                    return;
                   }
                   
                    let found = await docExistsOrNot(BV);
                    if (found==true) {
                     alert("this GP category is already added");
                     }else{
                            var ref= collection(db,"gpcategory");
                            const docRef= await addDoc(
                            ref,{
                                gpcategoryname:BV
                            });
                      
              box.innerHTML += '<tr>' + '<td><span id="' + docRef.id + '">' + BV + '</span></td>' 
              +'<td>' +
              '<input type="button" value="edit" class="update" data-ref="' + docRef.id + '">' +
              '</td>' + '</tr>';
              divtext.style.display = "none";   
             alert("GP category added successfully");
                 
             addUpdateEvents();        
                      
                          }


});
// ******************************************YOUR CODE (YOU can remove it)************************************************
// addbtn.addEventListener("click",AddDocument_AutoID);    
var StoringInputFliedValueToCompareIfItsChanngedWhenClickingUpdateButton="";    
  //********************************** UPDATE DATABASE ****************************************************************
    const addUpdateEvents = () => {
      
        for (var i = 0; i <  editbtn.length; i++) {
          editbtn.item(i).addEventListener('click', async function (event) {
          
       newaddbtn.style.display = "block";
      addbtn.style.display = "none";
      // editbtn.style.display = "block";
      updatebtn.style.display = "block";
      divtext.style.display = "block";
      canclebtn.style.display = "block";


 // ********************************HOW I CAN RETRIVE DATA IN TEXT BOX TO UPDATE IT ? *********************************

                          

            var categoryid=event.target.getAttribute('data-ref');
            let inputfield=document.getElementById("inputfield");
           const docRef = doc(db, "gpcategory", categoryid);
           const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
             
              updatebtn.setAttribute('data-ref', categoryid);
              inputfield.value=docSnap.data().gpcategoryname;
              StoringInputFliedValueToCompareIfItsChanngedWhenClickingUpdateButton=docSnap.data().gpcategoryname;
             } else {
            // doc.data() will be undefined in this case
             console.log("No such document!");
             }
          })
        }
      };

      addUpdateEvents();
     
      updatebtn.addEventListener('click', async function () {
      let inputfield=document.getElementById("inputfield");      
      var categoryid= updatebtn.getAttribute('data-ref');
      //alert(categoryid);


                   let BV2= inputfield.value;
                  if(BV2=="" || BV2==null){
                   alert("Please fill in the GP category name");
                   return;
                   }else if(/[\u0600-\u06FF\u0750-\u077F]/.test(BV2)){
                    alert("Only English is allowed");
                    return;
                   }else if(/^\d+$/.test(BV2)){
                    alert("GP category name cannot contain only digits");
                    return;
                   }else if(/^[^a-zA-Z0-9]+$/.test(BV2)){
                    alert("GP category name cannot contain only special characters");
                    return;
                   }else if(/^[`!@#$%^&*()_+\-=\[\]{};':"\\|,.< >\/?~\d]*$/g.test(BV2)){
                    alert("GP category name cannot contain only digits and special characters");
                    return;
                   }else if(StoringInputFliedValueToCompareIfItsChanngedWhenClickingUpdateButton==BV2){//if its exactly the same with capital and small and space layout(it will NOT be updated)
                   alert("You did not change the GP category name");
                   return;
                    }else if(StoringInputFliedValueToCompareIfItsChanngedWhenClickingUpdateButton.split(" ").join("").toLowerCase()==BV2.split(" ").join("").toLowerCase()){//if its the same with different capital or small or space layout(it will be updated)
                      try {
                        var ref= doc(db,"gpcategory",categoryid);
                        await updateDoc(
                        ref,{
                            gpcategoryname:BV2
                        })                     
                     
                   } catch (e) {
                    //in case there is an error! we dont update the page.
                    alert('We caught an error during update, refresh the page and try again!');
                    return;
                  }  
            
                      //updatepage
                      document.getElementById(categoryid).innerHTML = BV2;
                     divtext.style.display = "none";
                     alert("GP category has been updated successfully");
                     return;
                    }//end else if its the same with different capital and small and space layout(it will be updated)
               


                    //Checking if its already in the database
                     let found = await docExistsOrNot(BV2);
                     if (found==true) {
                     alert("This GP category is already in the system");
                     return;
                     }else{
                      try {
                        var ref= doc(db,"gpcategory",categoryid);
                        await updateDoc(
                        ref,{
                            gpcategoryname:BV2
                        })                     
                     
                   } catch (e) {
                    //in case there is an error! we dont update the page.
                    alert('We caught an error during update, refresh the page and try again!');
                    return;
                  }  
            
                //updatepage
                document.getElementById(categoryid).innerHTML = BV2;
                divtext.style.display = "none";
                alert("GP category updated successfully");
               }
    });

        
    const samevalue = async (categoryid, BV2) => {
    var same= false;
    const docRef = doc(db, "gpcategory", categoryid);
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) {
     same=true;
    }
    return same;
    }



  }//end all js



      
      </script> 






</body>
</html>