<!DOCTYPE html>
<html class="eClinic" lang="en">

<head>
  <link rel="stylesheet" href="index.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
  <link href='https://fonts.googleapis.com/css?family=Oswald:300' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Familjen Grotesk' rel='stylesheet'>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link id="theme-style" rel="stylesheet" href="semester.css">
  <link rel="icon" href="img/eClinicLogo-blue.png" type="image/x-icon" />
  <!-- MDB -->
  <!-- <link rel="stylesheet" href="css/mdb.min.css" /> -->
  <!-- for the logos in the sidebar -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <title>Semesters</title>
  <!--********************************************* STYLE THE TABLE**************************************************** -->

</head>

<body class="Site">


  <main>
    <div class="conterer ">

      <!-- Start profile icons  -->
      <div class="action" style="z-index: 99999; font-size: 14px;">
        <div class=" profile" onclick="menuToggle();">

          <img src="img/user.png" />

        </div>

        <div class="menu">

          <ul>

            <li>

              <img src="img/logout.png" /><a href="#" class="logout">Log Out</a>

            </li>

            <li>

              <img src="img/lock.png" /><a href="resetinner.html">Reset Password</a>

            </li>

          </ul>

        </div>

      </div>
      <!-- end profil icons  -->




      <!--***************************************** SHOW DATA IN HERE AFTER RETRIVING****************************************  -->

      <div class="row" style="margin-top: 4%;">

        <!-- side menu -->
        <div class="col-md-3" style="display: block;">
          <nav class="sidebar ">
            <img class="logo" src="img/logo.png" alt="logo brand" height="10%" width="50%">
            <a href="index.html"><i class="fa fa-fw fa-home"></i>Home</a>
            <a href="semesters.html" class="active_semester"><i class="fa fa-calendar"></i> Semesters</a>
            <a href="faculty.html"><i class="fa fa-group"></i> Faculty Members Speciality </a>
            <a href="GPCategory.html"><i class="fa fa-graduation-cap"></i>Graduation Projects Category</a>
            <a href="timeframe.html"><i class="fa fa-clock-o"></i> Help Desk Dates</a>
            <footer class="footer_eClinic">
              <p class="text-white text-justify position-absolute bottom-0 display-10"> Copyright &copy; All
                Rights
                Reserved to
                King Saud University.Made by eClinic Teams</p>
            </footer>
          </nav>
        </div>
        <!-- side menu -->
        <div class="col mt-3 card p-2 " style="display: block; margin-left: 0.5%;">
          <div class="d-flex justify-content-end">
            <input type="button" value="Add New Semester" id="add" class=" logbut btn btn-primary btn-lg"
              style="padding-left: 0.5rem; padding-right: 0.5rem; padding-bottom: 0.2rem; padding-top: 0.2rem; font-size: 18px;">
          </div>
          <!-- class="btn btn-primary" -->
          <h4 class="">Semesters</h4>

          <div style="display: none;" class="card border-warning mt-5 m-3 p-2 text-bg-warning" id="noItems">
            There is curretnly no semester.
          </div>

          <table class="show_info card-body table" style="width:100%; display: none;" id="mytable">

            <thead>
              <th style="width:50%"> Semester</th>
              <th style="width:70%"> Year</th>
              <th style="width:10%"></th>
            </thead>
            <tbody id="show_data">

            </tbody>

          </table>
        </div>

        <!-- right form -->
        <div class="col-md-3 ms-auto mt-3 card">
          <!-- start faculty list -->
          <div id="facultyList" class="m-3" style="display: none;">
            <select id="specialityList" class="form-select mb-2"></select>
            <ul id="facultyListData" class="list-group m-1">

            </ul>
          </div>
          <!-- / end faculty list -->
          <div style="display: none;" class="card border-success mt-5 m-3 p-2 text-success" id="message"></div>

          <form id="semester-year" class="col" style="display: none;">
            <div class="my-3">
              <label class="form-label" style="margin-bottom: 0.2px;">Semester</label>

              <select class="semester form-select" name="semester" id="semester">
                <option selected disabled>choose a semester</option>
                <option value="1st">1st</option>
                <option value="2nd">2nd</option>
                <option value="3rd">3rd</option>

              </select>
            </div>

            <label class="form-label" style="margin-bottom: 0.2px;"> Year</label>


            <div class="input-group mb-0">

              <select class="years form-select" name="year" id="firstyear">
                <option selected disabled>choose a year</option>
              </select>
              <span class="input-group-text">/</span>
              <select class="form-select" name="year" id="secondyear">
                <option selected disabled>choose a year</option>
              </select>
            </div>

            <div class="d-flex justify-content-evenly">
              <input type="button" value="Add" id="addtodb" class="mt-3 logbut btn btn-primary btn-lg"
                style="padding-left: 1.2rem; padding-right: 1.4rem; padding-bottom: 0.2rem; padding-top: 0.2rem; font-size: 18px;"
                style="display: none; ">
              <input type="button" value="Update" id="updatetodb" class="mt-3 logbut btn btn-primary btn-lg"
                style="padding-left: 0.5rem; padding-right: 0.5rem; padding-bottom: 0.2rem; padding-top: 0.2rem; font-size: 18px;"
                style="display: none;" data-ref="" data-current-value="">
              <input type="button" value="CANCEL" id="cancle" class="mt-3 btn btn-secondary" style="display: none; ">
            </div>
          </form>
        </div>
      </div>

    </div>
  </main>


  <!-- ****************************************End FrontEnd ***********************************************************  -->






  <!-- ******************************************link with firestore**************************************************** -->


  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-app.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
    import { getFirestore, doc, collection, query, where, getDocs, getDoc, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-firestore.js";
    import { getAuth, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-auth.js"; //import for authentication +signout
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD6JcSscRU6XaF3SaCF_U3ggXAFYUnKKq8",
      authDomain: "eclinic-d5dec.firebaseapp.com",
      projectId: "eclinic-d5dec",
      storageBucket: "eclinic-d5dec.appspot.com",
      messagingSenderId: "148819771062",
      appId: "1:148819771062:web:0cef59ac00e9c176247017"

    };

    // ************************************************** Initialize Firebase**********************************

    const app = initializeApp(firebaseConfig);
    const db = getFirestore();
    const auth = getAuth()


    setTimeout(() => {
      if (document.getElementById("noItems").style.display == "none")
        document.getElementById("mytable").style.display = "block";
    }, 2000);

    //get all faculty members of one semester
    async function getFaculty (semesterId) {


      //fix duplicated loading.
      if (document.getElementById("facultyList").style.display != 'none') {
        return;
      }

      document.getElementById("facultyListData").dataset.uniqueid = semesterId;
      document.getElementById("facultyListData").innerHTML = "<li>Wait...</li>";


      //get a fresh facultymembers from database
      const docSnap = await getDoc(doc(db, "semester", semesterId));

      var semesterFaculty;
      if (docSnap.exists()) {
        semesterFaculty = [];
      } else {
        const details = docSnap.data();
        semesterFaculty = details.facultymembers;
      }
      let found = semesterFaculty.length > 0;

      document.getElementById("facultyListData").innerHTML = "";


      let currentItem = 1;
      await semesterFaculty.forEach(async (docc) => {
        console.log("doc.faculty ", docc.faculty);
        const facultyDocRef = await getDoc(docc.faculty);
        let facultyData = facultyDocRef.data();
        let specialityList = "";
        let specialityListIDs = '';
        console.log("doc.specialty ", docc.specialty);
        if (docc.specialty != null) {
          for (let index = 0; index < docc.specialty.length; index++) {
            const element = docc.specialty[index];
            const qqSnapshot = await getDoc(docc.specialty[index]);
            let sp = qqSnapshot.data();
            specialityList += (specialityList != "" ? ", " : "") + sp.specialityname;
            specialityListIDs += (specialityListIDs != "" ? "," : '') + '"' + qqSnapshot.id + '"';
          };
        }

        if (document.getElementById("facultyListData").dataset.uniqueid == semesterId) {
          document.getElementById("facultyListData").innerHTML += '<li data-sp=\'[' + specialityListIDs + ']\' class="spitem list-group-item d-flex justify-content-between align-items-center">' + facultyData.firstname + ' ' + facultyData.lastname + '<span class="badge rounded-pill" style="background-color:#0084bd;">' + specialityList + '</span></li>';
        }
        if (currentItem == semesterFaculty.length) {
          document.getElementById('specialityList').disabled = false;
        }

        currentItem++;
      });



      if (!found) {
        document.getElementById('specialityList').style.display = 'none';
        document.getElementById('facultyListData').innerHTML += '<li class="list-group-item list-group-item-warning">No faculty is found to be listed under this semester!</li>';
      } else {
        document.getElementById('specialityList').style.display = 'block';
        document.getElementById('facultyListData').innerHTML += '<li class="list-group-item list-group-item-info text-center text-white" style="background-color:#0084bd;">Semester Faculty List</li>';
        document.getElementById('facultyListData').innerHTML += '<li id="no-faculty" class="list-group-item list-group-item-warning" style="display:none">No faculty is found to be listed under this sepciality!</li>';

      }

      document.getElementById("semester-year").style.display = "none";
      document.getElementById("facultyList").style.display = "block";

      return true;
    }

    // *********************************INITIALIZE ALL VARIBALES*********************************************
    document.onreadystatechange = async function () {
      let addnewbtn = document.getElementById("add");
      let addDBbtn = document.getElementById("addtodb");
      let updatebtn = document.getElementsByClassName("update");
      let showFacultyListbtn = document.getElementsByClassName("show-faculty");
      let updateDBbtn = document.getElementById("updatetodb");
      let canclebtn = document.getElementById("cancle");
      // **********************FOR DIV ***************************************************************************
      let addUpdatediv = document.getElementById("semester-year");
      let facultylistdiv = document.getElementById("facultyList");
      // ********************** FOR DROP DOWN ********************************************************************
      let semesterDropdown = document.getElementById("semester");
      let dateDropdown1 = document.getElementById("firstyear");
      let dateDropdown2 = document.getElementById("secondyear");
      let box = document.getElementById("show_data");
      let hasNoItems = true;
      let specialityList = document.getElementById("specialityList");
      // let semestersFacultyList = {};
      // ********************** get all docs********************************************************************

      //get all specialities
      const specialityCollection = query(collection(db, "facultyspeciality"));
      const specialityDocs = await getDocs(specialityCollection);
      specialityList.innerHTML += '<option value="0" selected>All</option>';
      specialityDocs.forEach((doc) => {
        let detail = doc.data();
        specialityList.innerHTML += '<option value="' + doc.id + '">' + detail.specialityname + '</option>';
      });

      const q = query(collection(db, "semester"));
      const querySnapshot = await getDocs(q);
      querySnapshot.forEach((doc) => {
        hasNoItems = false;
        // doc.data() is never undefined for query doc snapshots
        let detail = doc.data();
        let text = detail.semestername;
        const myArray = text.split(" ");

        // semestersFacultyList[doc.id] = detail.facultymembers ?? [];

        box.innerHTML += '<tr>' + '<td><span id="semester-' + doc.id + '">' + myArray[0] + '</span></td>' + '<td><span id="year-' + doc.id + '"">' + myArray[1] + '</span></td>' +
          '<td class="d-flex justify-content-between">' +
          '<button id="' + doc.id + '-ref" type="button" class=" update logbut btn btn-primary mx-2" style="border:0" data-ref="' + doc.id + '"><i class="fa fa-pencil" aria-hidden="true"></i></button>' +
          '<button id="' + doc.id + '-sesmster" type="button" class=" show-faculty logbut btn btn-primary mx-2" style="border:0"  data-semester="' + doc.id + '"><i class="fa fa-users" aria-hidden="true"></i></button>' +
          '</td>' + '</tr>';
      });

      hasItemsCheck();




      // ********************** set years********************************************************************

      let earliestYear = 2050;
      let currentYear1 = new Date().getFullYear();
      while (currentYear1 <= earliestYear) {
        var dateOption = document.createElement("option");
        dateOption.text = currentYear1;
        dateOption.value = currentYear1;
        dateDropdown1.add(dateOption);
        currentYear1 += 1;
      }

      let currentYear2 = new Date().getFullYear();
      while (currentYear2 <= earliestYear) {
        var dateOption = document.createElement("option");
        dateOption.text = currentYear2;
        dateOption.value = currentYear2;
        dateDropdown2.add(dateOption);
        currentYear2 += 1;
      }
      // ********************** reset function********************************************************************
      const resetForm = () => {
        semesterDropdown.value = "choose a semester"
        dateDropdown1.value = "choose a year"
        dateDropdown2.value = "choose a year"
      }

      // ********************** 1-CLICK ADD BUTTON WITH VALUE(ADD NEW SEMESTER/YEAR)************************************
      addnewbtn.addEventListener('click', function () {
        resetForm();
        addUpdatediv.style.display = "block";
        addDBbtn.style.display = "block";
        updateDBbtn.style.display = "none";
        facultylistdiv.style.display = "none";
        canclebtn.style.display = "block";
      });

      // ********************** CLICK CANCLE BUTTON WITH VALUE(CANCLE)****************************************************

      canclebtn.addEventListener('click', function () {
        {
          if (confirm("Are you sure you want to cancle your work?") == true) {
            addUpdatediv.style.display = "none";
            resetForm();
          }
          else
            return false;
        }
      })
      specialityList.addEventListener('change', function (event) {
        const items = document.querySelectorAll('.spitem');
        let foundItems = 0;
        items.forEach(p => {
          let x = JSON.parse(p.dataset.sp);

          if (x.includes(specialityList.value) || specialityList.value == 0) {
            p.style.display = '';
            foundItems++;
          } else {
            p.setAttribute('style', 'display:none !important');
          }
        });
        console.log(foundItems)

        if (foundItems == 0) {
          document.getElementById('no-faculty').style.display = 'block'
        } else {
          document.getElementById('no-faculty').style.display = 'none'
        }
      });


      // ********************** for yallow alert ****************************************************
      function hasItemsCheck () {
        if (hasNoItems) {
          document.getElementById('noItems').style.display = 'block';
          document.getElementById('mytable').style.display = 'none';
        } else {
          document.getElementById('mytable').style.display = 'block';
          document.getElementById('noItems').style.display = 'none';
        }
      }
      // ********************** for green alert ****************************************************
      function successMessage (message) {
        document.getElementById('message').innerHTML = message;
        document.getElementById('message').style.display = "block";

        setTimeout(() => {
          var elems = document.querySelectorAll("tr.table-success");

          [].forEach.call(elems, function (el) {
            el.classList.remove("table-success");
          });
          document.getElementById('message').style.display = "none";
        }, 5000);
      }
      // ********************** for checking drop down ****************************************************
      function checkSemesterDates () {
        if (semesterDropdown.value == "choose a semester") {
          alert("please choose a semester");
          return '';
        }

        if (dateDropdown1.value == "choose a year") {
          alert("please choose the first year");
          return '';
        }
        if (dateDropdown2.value == "choose a year") {
          alert("please choose the second year");
          return '';
        }
        let extra = '';

        if (dateDropdown2.value != "choose a year") {
          if (dateDropdown2.value < dateDropdown1.value) {
            alert("the second year must be after the first year");
            return '';
          }

          extra = '/' + dateDropdown2.value;
        }

        if (dateDropdown2.value != "choose a year") {
          if (dateDropdown2.value - 1 != dateDropdown1.value & dateDropdown2.value - 1 > dateDropdown1.value) {
            alert("The duration between the first year and the second year should be one year");
            return '';
          }

          extra = '/' + dateDropdown2.value;
        }

        return semesterDropdown.value + " " + dateDropdown1.value + extra;
      }

      // ********************** exists docs ****************************************************
      const docExistsOrNot = async (semesteryearname) => {
        var found = false;
        const qadd = query(collection(db, "semester"));
        const querySnapshotadd = await getDocs(qadd);
        querySnapshotadd.forEach((doc) => {
          if (doc.data().semestername == semesteryearname) {
            found = true;
          }
        });

        return found;
      }

      // ********************** 1-CLICK ADD BUTTON WITH VALUE(ADD)********************************************************

      addDBbtn.addEventListener('click', async function () {

        let semesteryearname = checkSemesterDates();

        if (semesteryearname == '') {
          return;
        }
        addDBbtn.setAttribute("disabled", "disabled");

        // ********************** 3-CHECK IF THE SEMESTER ADDED BEFORE************************************
        let found = await docExistsOrNot(semesteryearname);
        if (found) {
          alert("This semester is already added");
        } else {

          if (semesteryearname != "") {
            const docRef = await addDoc(collection(db, "semester"), {
              semestername: semesteryearname,
              enddate: null,
              startdate: null,

            });

            const myArray = semesteryearname.split(" ");

            box.innerHTML += '<tr class="table-success">' + '<td><span id="semester-' + docRef.id + '">' + myArray[0] + '</span></td>' + '<td><span id="year-' + docRef.id + '"">' + myArray[1] + '</span></td>' +
              '<td class="d-flex justify-content-between">' +
              '<button id="' + doc.id + '-ref" type="button" class=" update logbut btn btn-primary mx-2" style=" border:0" data-ref="' + docRef.id + '"><i class="fa fa-pencil" aria-hidden="true"></i></button>' +
              '<button id="' + doc.id + '-semester" type="button" class=" show-faculty logbut btn btn-primary mx-2" style=" border:0"  data-semester="' + docRef.id + '"><i class="fa fa-users" aria-hidden="true"></i></button>' +
              '</td>' + '</tr>';

            document.getElementById("semester-year").style.display = "none";
            hasNoItems = false;
            hasItemsCheck();
            successMessage('Semester has been added successfully');
            addUpdateEvents();
          }
        }
        document.getElementById("addtodb").removeAttribute("disabled");
      })

      // ********************** CLICK UPDATE BUTTON WITH VALUE(edit) WITH UNIQUE ID**********************

      const addUpdateEvents = () => {
        for (var i = 0; i < updatebtn.length; i++) {
          showFacultyListbtn.item(i).addEventListener('click', async function (event) {
            document.getElementById("facultyList").style.display = "none";
            let docSemester = event.target.dataset.semester;
            if (!docSemester) {
              docSemester = event.currentTarget.dataset.semester;
            }

            console.log("docSemester:show-press:" + docSemester);
            specialityList.value = 0;
            document.getElementById('specialityList').disabled = true;
            await getFaculty(docSemester);
          });

          updatebtn.item(i).addEventListener('click', async function (event) {
            addUpdatediv.style.display = "block";
            addDBbtn.style.display = "none";
            updateDBbtn.style.display = "block";
            canclebtn.style.display = "block";
            facultylistdiv.style.display = "none";


            // **************************HOW I CAN RETRIVE DATA IN DROP DOWN TO UPDATE IT ? ********************


            let docRef = event.target.dataset.ref;
            if (!docRef) {
              docRef = event.currentTarget.dataset.ref;
            }
            console.log("docref:edit-press:", docRef);


            const docSnap = await getDoc(doc(db, "semester", docRef));

            if (docSnap.exists()) {
              console.log("Document data:", docSnap.data());
              const details = docSnap.data();
              updateDBbtn.setAttribute('data-ref', docRef);
              updateDBbtn.setAttribute('data-current-value', details.semestername);

              const semester = details.semestername.split(" ");

              if (semester[1].indexOf('/') != -1) {
                const dates = semester[1].split("/");
                dateDropdown1.value = dates[0];
                dateDropdown2.value = dates[1];
              } else {
                dateDropdown1.value = semester[1];
                dateDropdown2.value = 'choose a year';
              }

              semesterDropdown.value = semester[0];
            } else {
              console.log("No such document! ref: " + id);
            }
          })
        }
      };

      addUpdateEvents();

      //************************ CLICK UPDATE BUTTON WITH VALUE(UPDATE)**************************************


      updateDBbtn.addEventListener('click', async function () {
        let semesteryearname = checkSemesterDates();
        console.log('z:semesteryearname:updateDBbtn.even: ' + semesteryearname);

        if (semesteryearname == '') {
          return;
        }


        updateDBbtn.setAttribute("disabled", "disabled");

        let docCurrentValue = updateDBbtn.getAttribute('data-current-value');

        if (docCurrentValue == semesteryearname) {
          alert("You didn't make any change ...");
          updateDBbtn.removeAttribute("disabled");
          return;
        }

        let found = await docExistsOrNot(semesteryearname);
        if (found) {
          alert("This semester is already in the database. Choose Another name.");
          updateDBbtn.removeAttribute("disabled");
          return;
        }

        console.log('x:semesteryearname:updateDBbtn.even: ' + semesteryearname);

        let docRef = updateDBbtn.getAttribute('data-ref');

        console.log('docRef:updateDBbtn.even: ' + docRef);

        try {
          await updateDoc(doc(db, "semester", docRef), {
            semestername: semesteryearname
          });
        } catch (e) {
          //in case there is an error! we dont update the page.
          alert('We caught an error during update, refresh the page and try again!');
          return;
        }

        //update page
        const myArray = semesteryearname.split(" ");
        console.log('docRef:updateDBbtn.myArray: ' + myArray[0] + ',' + myArray[1]);

        document.getElementById('semester-' + docRef).innerHTML = myArray[0];
        document.getElementById('year-' + docRef).innerHTML = myArray[1];
        addUpdatediv.style.display = "none";

        document.getElementById('semester-' + docRef).parentNode.parentElement.classList.add('table-success');

        successMessage('This semester has been updated successfully');
        updateDBbtn.removeAttribute("disabled");
      });


    };
    ////////////////////////////////////////logout/////////////////////////////////
    const logout = document.querySelector('.logout')
    logout.addEventListener("click", () => {
      const conf = confirm("Are you sure you want to log out?")

      if (conf === true) {
        signOut(auth)
          .then(() => {
            console.log("user log out")
          })
          .catch((err) => {
            console.log(err.message)
          })

        window.location.replace("login.html")
      }


    });

    /////////////////////////there is authentication for each page  /////////////////////////
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // console.log("the same user")
        uid = user.uid;
      }
      else {
        signOut(auth)
        window.location.replace("login.html")
          .then(() => {
            console.log("user log out")
          })
          .catch((err) => {
            console.log(err.message)
          })
      }
      console.log("the user status change :", user)
    })


  </script>
  <script>
    // start: java sript for profile icons 
    function menuToggle () {
      const toggleMenu = document.querySelector(".menu");
      toggleMenu.classList.toggle("active");
    }
        // End: java sript for profile icons
  </script>


</body>

</html>