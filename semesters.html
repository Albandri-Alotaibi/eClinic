<!DOCTYPE html>
<html class="eClinic" lang="en">

<head>
  <link rel="stylesheet" href="index.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
  <link href='https://fonts.googleapis.com/css?family=Oswald:300' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Familjen Grotesk' rel='stylesheet'>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link id="theme-style" rel="stylesheet" href="semester.css">
  <!-- MDB -->
  <!-- <link rel="stylesheet" href="css/mdb.min.css" /> -->
  <!-- for the logos in the sidebar -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <title>Semesters Page</title>
  <!--********************************************* STYLE THE TABLE**************************************************** -->

</head>

<body class="Site">


  <main>
    <div class="conterer ">

      <!-- Start profil icons  -->
      <div class="action" style="z-index: 99999; font-size: 14px;">
        <div class=" profile" onclick="menuToggle();">

          <img src="img/user.png" />

        </div>

        <div class="menu" >

          <ul>

            <li>

              <img src="img/logout.png" /><a href="#" class="logout">Log Out</a>

            </li>

            <li>

              <img src="img/lock.png" /><a href="resetinner.html">Reset password</a>

            </li>

          </ul>

        </div>

      </div>
      <!-- end profil icons  -->

      


      <!--***************************************** SHOW DATA IN HERE AFTER RETRIVING****************************************  -->

      <div class="row" style="margin-top: 4%;">

        <!-- side menu -->
        <div class="col-md-3" style="display: block;" >
          <nav class="sidebar ">
            <img class="logo" src="img/logo.png" alt="logo brand" height="10%" width="50%">
            <a href="index.html"><i class="fa fa-fw fa-home"></i>Home</a>
            <a href="semesters.html" class="active_semester"><i class="fa fa-calendar"></i> Semesters</a>
            <a href="faculty.html"><i class="fa fa-group"></i> Faculty Members Speciality </a>
            <a href="GPCategory.html"><i class="fa fa-graduation-cap"></i> Graduation projects </a>
            <a href="timeframe.html"><i class="fa fa-clock-o"></i> Help desk timeframe</a>
            <footer class="footer_eClinic">
              <p class="text-white text-justify position-absolute bottom-0 display-10"> Copyright &copy; All
                Rights
                Reserved to
                King Saud University.Made by eClinic Teams</p>
            </footer>
          </nav>
        </div>

        <div class="col mt-3 card p-2 " style="display: block; margin-left: 0.5%;" >
          <div class="d-flex justify-content-end">
            <input type="button" value="Add New Semster" id="add" class=" logbut btn btn-primary btn-lg"
              style="padding-left: 0.5rem; padding-right: 0.5rem; padding-bottom: 0.2rem; padding-top: 0.2rem; font-size: 18px;">
          </div>
          <!-- class="btn btn-primary" -->
          <table class="show_info card-body table" id="mytable" >
            <h4 class="">Semesters</h4>
            <thead>
              <th > Semester</th>
              <th > Year</th>
              <th></th>
            </thead>
            <tbody id="show_data" >

            </tbody>

          </table>
        </div>

        <!-- right form -->
        <div class="col-md-3 ms-auto mt-3 card">
          <form id="semester-year" class="col" style="display: none;">
            <div class="my-3">
              <label class="form-label">Choose a semester</label>
              <select class="semester form-select" name="semester" id="semester">
                <option selected disabled>choose a semester</option>
                <option value="1st">1st</option>
                <option value="2nd">2nd</option>
                <option value="3rd">3rd</option>
              </select>
            </div>

            <label class="form-label">Choose year</label>
            <div class="input-group mb-0">
              <select class="years form-select" name="year" id="firstyear">
                <option selected disabled>choose a year</option>
              </select>
              <span class="input-group-text">/</span>
              <select class="form-select" name="year" id="secondyear">
                <option selected value="choose a year">choose a year</option>
              </select>
            </div>

            <div class="d-flex justify-content-evenly">
              <input type="button" value="Add" id="addtodb" class="mt-3 logbut btn btn-primary btn-lg"
                style="padding-left: 1.2rem; padding-right: 1.4rem; padding-bottom: 0.2rem; padding-top: 0.2rem; font-size: 18px;"
                style="display: none; ">
              <input type="button" value="update" id="updatetodb" class="mt-3 logbut btn btn-primary btn-lg"
                style="padding-left: 0.5rem; padding-right: 0.5rem; padding-bottom: 0.2rem; padding-top: 0.2rem; font-size: 18px;"
                style="display: none;" data-ref="">
              <input type="button"  value="cancle" id="cancle" class="mt-3 btn btn-secondary" style="display: none; ">
            </div>
          </form>
        </div>
      </div>


      <!--******************************* DROP DOWN & BUTTONS WITH VALUE(ADD,UBDATE,CANCLE)********************************** -->




      <!-- Start side Mnue  -->




      <!-- End side Mnue  -->

      <!-- ****************************************End FrontEnd ***********************************************************  -->
    </div>
  </main>





  <!-- ******************************************link with firestore**************************************************** -->


  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-app.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
    import { getFirestore, doc, collection, query, where, getDocs, getDoc, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-firestore.js";
    import { getAuth, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-auth.js"; //import for authentication +signout
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD6JcSscRU6XaF3SaCF_U3ggXAFYUnKKq8",
      authDomain: "eclinic-d5dec.firebaseapp.com",
      projectId: "eclinic-d5dec",
      storageBucket: "eclinic-d5dec.appspot.com",
      messagingSenderId: "148819771062",
      appId: "1:148819771062:web:0cef59ac00e9c176247017"

    };

    // ************************************************** Initialize Firebase**********************************

    const app = initializeApp(firebaseConfig);
    const db = getFirestore();
    const auth = getAuth()

    // ***************************************RETRIVE DATA & FILL DATA IN TABLE ********************************






    // *********************************INITIALIZE ALL VARIBALES*********************************************
    document.onreadystatechange = async function () {
      let addnewbtn = document.getElementById("add");
      let addDBbtn = document.getElementById("addtodb");
      let updatebtn = document.getElementsByClassName("update");
      let updateDBbtn = document.getElementById("updatetodb");
      let canclebtn = document.getElementById("cancle");
      // **********************FOR DIV ***************************************************************************
      let addUpdatediv = document.getElementById("semester-year");
      // ********************** FOR DROP DOWN ********************************************************************
      let semesterDropdown = document.getElementById("semester");
      let dateDropdown1 = document.getElementById("firstyear");
      let dateDropdown2 = document.getElementById("secondyear");
      let box = document.getElementById("show_data");


      //get all docs
      const q = query(collection(db, "semester"));
      const querySnapshot = await getDocs(q);
      querySnapshot.forEach((doc) => {
        // doc.data() is never undefined for query doc snapshots
        let detail = doc.data();
        let text = detail.semestername;
        const myArray = text.split(" ");
        box.innerHTML += '<tr>' + '<td><span id="semester-' + doc.id + '">' + myArray[0] + '</span></td>' + '<td><span id="year-' + doc.id + '"">' + myArray[1] + '</span></td>' +
          '<td>' +
          '<input type="button" value="✎"  class=" update logbut btn btn-primary btn-lg"  style="padding-left: 0.5rem; padding-right: 0.5rem; padding-bottom: 0.2rem; padding-top: 0.2rem; font-size: 18px; left:100%;" data-ref="' + doc.id + '">' +
          '</td>' + '</tr>';
      });



      //set years
      let earliestYear = 2050;
      let currentYear1 = new Date().getFullYear();
      while (currentYear1 <= earliestYear) {
        var dateOption = document.createElement("option");
        dateOption.text = currentYear1;
        dateOption.value = currentYear1;
        dateDropdown1.add(dateOption);
        currentYear1 += 1;
      }

      let currentYear2 = new Date().getFullYear();
      while (currentYear2 <= earliestYear) {
        var dateOption = document.createElement("option");
        dateOption.text = currentYear2;
        dateOption.value = currentYear2;
        dateDropdown2.add(dateOption);
        currentYear2 += 1;
      }

      const resetForm = () => {
        semesterDropdown.value = "choose a semester"
        dateDropdown1.value = "choose a year"
        dateDropdown2.value = "choose a year"
      }

      // ********************** 1-CLICK ADD BUTTON WITH VALUE(ADD NEW SEMESTER/YEAR)************************************
      addnewbtn.addEventListener('click', function () {
        resetForm();
        addUpdatediv.style.display = "block";
        addDBbtn.style.display = "block";
        updateDBbtn.style.display = "none";
        canclebtn.style.display = "block";
      });

      // ********************** CLICK CANCLE BUTTON WITH VALUE(CANCLE)****************************************************

      canclebtn.addEventListener('click', function () {
       {
          if (confirm("Are you sure to want to cancle your work?") == true){
            addUpdatediv.style.display = "none";
        resetForm();
          }
          else
              return false;
      
  }
      })

      function checkSemesterDates() {
        if (semesterDropdown.value == "choose a semester") {
          alert("please choose a semester");
          return '';
        }

        if (dateDropdown1.value == "choose a year") {
          alert("please choose the first year");
          return '';
        }

        let extra = '';

        if (dateDropdown2.value != "choose a year") {
          if (dateDropdown2.value <= dateDropdown1.value) {
            alert("the second year must be after the first year");
            return '';
          }

          extra = '/' + dateDropdown2.value;
        }

        if (dateDropdown2.value != "choose a year") {
          if (dateDropdown2.value - 1 != dateDropdown1.value) {
            alert("The duration between first year and the second year should be one year");
            return '';
          }

          extra = '/' + dateDropdown2.value;
        }

        return semesterDropdown.value + " " + dateDropdown1.value + extra;
      }

      const docExistsOrNot = async (semesteryearname) => {
        var found = false;
        const qadd = query(collection(db, "semester"));
        const querySnapshotadd = await getDocs(qadd);
        querySnapshotadd.forEach((doc) => {
          if (doc.data().semestername == semesteryearname) {
            found = true;
          }
        });

        return found;
      }

      // ********************** 1-CLICK ADD BUTTON WITH VALUE(ADD)********************************************************

      addDBbtn.addEventListener('click', async function () {

        let semesteryearname = checkSemesterDates();

        if (semesteryearname == '') {
          return;
        }


        // ********************** 3-CHECK IF THE SEMESTER ADDED BEFORE************************************
        let found = await docExistsOrNot(semesteryearname);
        if (found) {
          alert("this semester/year is already added");
        } else {
          if (semesteryearname != "") {
            const docRef = await addDoc(collection(db, "semester"), {
              semestername: semesteryearname,
              enddate: null,
              startdate: null,
              timeframe: false
            });

            const myArray = semesteryearname.split(" ");

            box.innerHTML += '<tr>' + '<td><span id="semester-' + docRef.id + '">' + myArray[0] + '</span></td>' + '<td><span id="year-' + docRef.id + '"">' + myArray[1] + '</span></td>' +
              '<td>' +
              '<input type="button" value="✎" class="update logbut btn btn-primary btn-lg"  style="padding-left: 0.5rem; padding-right: 0.5rem; padding-bottom: 0.2rem; padding-top: 0.2rem; font-size: 18px; left:100%;" data-ref="' + docRef.id + '">' +
              '</td>' + '</tr>';


            addUpdateEvents();
            addUpdatediv.style.display = "none";
            alert('New item has been added...');
          }
        }
      })

      // ********************** CLICK UPDATE BUTTON WITH VALUE(edit) WITH UNIQUE ID**********************

      const addUpdateEvents = () => {
        for (var i = 0; i < updatebtn.length; i++) {
          updatebtn.item(i).addEventListener('click', async function (event) {
            addUpdatediv.style.display = "block";
            addDBbtn.style.display = "none";
            updateDBbtn.style.display = "block";
            canclebtn.style.display = "block";

            // **************************HOW I CAN RETRIVE DATA IN DROP DOWN TO UPDATE IT ? ********************


            let docRef = event.target.getAttribute('data-ref');
            console.log("docref:edit-press:", docRef);

            const docSnap = await getDoc(doc(db, "semester", docRef));

            if (docSnap.exists()) {
              console.log("Document data:", docSnap.data());
              const details = docSnap.data();
              updateDBbtn.setAttribute('data-ref', docRef);

              const semester = details.semestername.split(" ");

              if (semester[1].indexOf('/') != -1) {
                const dates = semester[1].split("/");
                dateDropdown1.value = dates[0];
                dateDropdown2.value = dates[1];
              } else {
                dateDropdown1.value = semester[1];
                dateDropdown2.value = 'choose a year';
              }

              semesterDropdown.value = semester[0];
            } else {
              console.log("No such document! ref: " + id);
            }
          })
        }
      };

      addUpdateEvents();

      //************************ CLICK UPDATE BUTTON WITH VALUE(UPDATE)**************************************


      updateDBbtn.addEventListener('click', async function () {
        let semesteryearname = checkSemesterDates();
        console.log('z:semesteryearname:updateDBbtn.even: ' + semesteryearname);

        if (semesteryearname == '') {
          return;
        }

        let found = await docExistsOrNot(semesteryearname);
        if (found) {
          alert("You did not change the symester/year");
          return;
        }

        console.log('x:semesteryearname:updateDBbtn.even: ' + semesteryearname);

        let docRef = updateDBbtn.getAttribute('data-ref');
        console.log('docRef:updateDBbtn.even: ' + docRef);

        try {
          await updateDoc(doc(db, "semester", docRef), {
            semestername: semesteryearname
          });
        } catch (e) {
          //in case there is an error! we dont update the page.
          alert('We caught an error during update, refresh the page and try again!');
          return;
        }

        //update page
        const myArray = semesteryearname.split(" ");
        console.log('docRef:updateDBbtn.myArray: ' + myArray[0] + ',' + myArray[1]);

        document.getElementById('semester-' + docRef).innerHTML = myArray[0];
        document.getElementById('year-' + docRef).innerHTML = myArray[1];
        addUpdatediv.style.display = "none";
        alert('This semester/year has been updated.');
      });


    };
////////////////////////////////////////logout/////////////////////////////////
    const logout = document.querySelector('.logout')
      logout.addEventListener("click", () => {
        const conf = confirm("are you sure to log out?")

        if (conf === true) {
          signOut(auth)
            .then(() => {
              //console.log("user log out")
            })
            .catch((err) => {
              console.log(err.message)
            })

          window.location.replace("login.html")
        }


      });

    /////////////////////////there is authentication for each page  /////////////////////////
    onAuthStateChanged(auth, (user) => {
        if (user) {
          console.log("the same user")
         


        }
        else {
          signOut(auth)
          window.location.replace("login.html")
            .then(() => {
              console.log("user log out")
            })
            .catch((err) => {
              console.log(err.message)
            })
        }
        console.log("the user status change :", user)
      })


  </script>
  <script>
    // start: java sript for profile icons 
    function menuToggle() {
      const toggleMenu = document.querySelector(".menu");
      toggleMenu.classList.toggle("active");
    }
        // End: java sript for profile icons
  </script>


</body>

</html>