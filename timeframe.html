<!DOCTYPE html>
<html lang="en">

<head>
    <!-- <link rel="stylesheet" href="home.css"> -->
    <link href='https://fonts.googleapis.com/css?family=Oswald:300' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Familjen Grotesk' rel='stylesheet'>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link id="theme-style" rel="stylesheet" href="timeframestyle.css">

    <title>semester selection</title>

</head>
<header class="header_eClinic">
    <div class="img1">
        <a href="index.html"> <img class="logo" src="images/logo5.png" alt="logo"></a>
    </div>
    <div class="container blue topBotomBordersOut">
        <a href="index.html">Home</a>
        <a>Faculty members/Common issues category</a>
        <a href="semesters.html">Semesters/Years</a>
        <a>Graduation projects category</a>
        <a>Help desk timeframe</a>
        <div class="navigation">
            <a class="button_eClinic" href=""> <img class="profile" alt="profile"
                    src="https://i.pinimg.com/736x/0e/b0/fa/0eb0fa9667a46e226615651efe7218a5.jpg">
                <div class="logout">LOG OUT</div>
            </a>
        </div>
    </div>
</header>



<body class="Site">
    <main>
        <ul class="breadcrumb">
            <li><a href="index.html">Home</a></li>
            <li><a href="#">help desk timeframe</a></li>
        </ul>


        <form>
            <div class="parent-deem">
                <div id="selection-deem" style=" margin-top:5%; margin-left: 30%;">
                    <div>
                        <label>Please choose a semester/year</label><br>
                        <div class="deem-menu">
                            <select id="selectsemester" class="sem">
                                <option selected disabled>Please choose a semester</option>
                            </select>
                        </div>
                        <br><input type="button" id="next" value="next" class="button-next-Deem"><br>
                    </div>

                    <!-- <button id="next" value="next">next</button> -->
                </div>


                <div id="add-update-timeframe" style="display: none; ">


                    <label>choose a start date</label>
                    <input type="date" id="start-date"><br>
                    <label>choose an end date</label>
                    <input type="date" id="end-date"><br><br>
                    <input type="button" id="add" value="add" style="display: none;" class="button-next-Deem">
                    <input type="button" id="update" value="update" style="display: none;" class="button-next-Deem">


                </div>
            </div>
        </form>


    </main>



    <footer class="footer_eClinic">
        <small>Copyright &copy; All rights reserved to King Saud University. This website made with ðŸ’™ by eClinic teams.
        </small>
    </footer>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-app.js";

        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
        import { getFirestore, doc, collection, getDocs, getDoc, Timestamp, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-firestore.js";
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD6JcSscRU6XaF3SaCF_U3ggXAFYUnKKq8",
            authDomain: "eclinic-d5dec.firebaseapp.com",
            projectId: "eclinic-d5dec",
            storageBucket: "eclinic-d5dec.appspot.com",
            messagingSenderId: "148819771062",
            appId: "1:148819771062:web:fda813cec9a70acf247017"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore()



        //---------------------------get all elements i want------------------------

        let semesterSelect = document.getElementById("selectsemester");
        let divselect = document.getElementById("selection-deem");
        let nextbtn = document.getElementById("next");
        let divAddUpdate = document.getElementById("add-update-timeframe");
        let startDatecal = document.getElementById("start-date");
        let endDatecal = document.getElementById("end-date");
        let addbtn = document.getElementById("add");
        let updatebtn = document.getElementById("update");
        var start = 0;
        var end = 0;

        //-------------------------------get the semesters and add them in the drop down menu-------------------
        async function getSemesters() {
            const querySnapshot = await getDocs(collection(db, "semester"));
            querySnapshot.forEach((doc) => { //loop for all doc in the collection
                // doc.data() is never undefined for query doc snapshots
                var option = document.createElement("option");
                option.text = doc.data().semestername;
                option.value = doc.id;
                semesterSelect.add(option);

            });
        }
        semesterSelect.addEventListener("change", function () { // if the admin choose another semester the add-update disaper
            divAddUpdate.style.display = "none";
            addbtn.style.display = "none";
            updatebtn.style.display = "none";
            divselect.style.marginLeft = "30%";
        })
        //--------------------------call the getSemesters function onload of the page -----------------------------------
        window.onload = function () {
            getSemesters();

        };

        //-----------------after choosing the semester we should check if she already added the time frame befor or not -----------
        async function CheckChosenSemester() {
            startDatecal.value = null; //if the admin choose a semester that has a start/end date 
            endDatecal.value = null;   //then go back for one that dose not have we delet the old data

            var inputID = null;
            inputID = semesterSelect.value;
            // alert(inputID);
            if (inputID == 'Please choose a semester')  // if the admin did not choose a semester
                alert("Please choose a semester/year");
            else { // if the admin chooses a semester
                //---------------fix the style----------------
                divselect.style.marginLeft = "10%";
                divAddUpdate.style.marginLeft = "3%";
                divAddUpdate.style.marginTop = "5%";
                divAddUpdate.style.height = "50%";
                divAddUpdate.style.display = "block"; // to show the add/update section
                //-----------end of fis the style--------------



                const docRef = doc(db, "semester", inputID); // get the doc with the id we took from the option value for firestore
                const docSnap = await getDoc(docRef);//get the info of the doc?


                if (docSnap.data().timeframe == false) {//this semester does not have a timeftame
                    addbtn.style.display = "block";



                } else {// if the semester had time frame

                    updatebtn.style.display = "block";//we show the update btn
                    //in her we get the stord date in firestore and converted to js object and store show it in the input date value

                    // let startDateMillSec = docSnap.data().startdate.seconds * 1000;//get the date in milliseconds
                    let startDateMillSec = docSnap.data().startdate.toDate();//to get an js date obj  
                    let startdateobj = new Date(startDateMillSec);
                    let day = startdateobj.getDate();
                    let month = startdateobj.getMonth() + 1; //jan 0 not 1
                    let year = startdateobj.getFullYear();
                    if (day < 10)//to add 0 at the beginning of the number to match the js format yyy-mm-dd
                        day = "0" + day;
                    if (month < 10)
                        month = "0" + month;
                    let dateString = year + "-" + month + "-" + day;// to match the format yyy-mm-dd
                    startDatecal.value = dateString;

                    let endDateMillSec = docSnap.data().enddate.toDate();//to get an js date obj  
                    let endDateobj = new Date(endDateMillSec);
                    let day2 = endDateobj.getDate();
                    let month2 = endDateobj.getMonth() + 1; //jan 0 not 1
                    let year2 = endDateobj.getFullYear();
                    if (day2 < 10)
                        day2 = "0" + day2;
                    if (month2 < 10)
                        month2 = "0" + month2;
                    let dateString2 = year2 + "-" + month2 + "-" + day2;
                    endDatecal.value = dateString2;

                    //var flag = false;


                }


            }

        }

        nextbtn.addEventListener("click", CheckChosenSemester);

        addbtn.addEventListener('click', async function () { //we wait entel the adimn click add
            const docRefadd = doc(db, "semester", semesterSelect.options[semesterSelect.selectedIndex].value); // get the doc with the id we took from the option value for firestore
            const docSnapadd = await getDoc(docRefadd);//get the info of the doc?
            start = startDatecal.value;
            end = endDatecal.value;
            if (start == "" || end == "")//if the admin did not choose a start or end date
                alert("please choose a start and an end date");
            else {//if the admin chooses a start and end dates
                var today = new Date();
                
                if (new Date(start) < today) {//alert if the start date in the past
                    alert("please choose a starting day in the future");
                } else if (start > end) {
                    alert("please choose a start day that is before the end date");
                } else {
                    await updateDoc(docRefadd, { // we add the new time to a smester that dosenot have a time frame
                        startdate: Timestamp.fromDate(new Date(start + "T00:00:00")),
                        enddate: Timestamp.fromDate(new Date(end + "T23:59:59")),
                        timeframe: true

                    });
                    alert("your work has been added successfully")
                    window.location.replace("index.html");
                }
            }
        })

        updatebtn.addEventListener('click', async function () { //we wait entel the adimn click update

            const docRefup = doc(db, "semester", semesterSelect.options[semesterSelect.selectedIndex].value); // get the doc with the id we took from the option value for firestore
            const docSnapup = await getDoc(docRefup);//get the info of the doc?
            start = startDatecal.value;
            end = endDatecal.value;

            await updateDoc(docRefup, { // we update the time to a smester 
                startdate: Timestamp.fromDate(new Date(start + "T00:00:00")),
                enddate: Timestamp.fromDate(new Date(end + "T23:59:59")),
                timeframe: true
            });

            alert("your work has been updated successfully");
            window.location.replace("index.html");
        })

    </script>
</body>

</html>