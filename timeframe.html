<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="index.css">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">


    <link href='https://fonts.googleapis.com/css?family=Oswald:300' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Familjen Grotesk' rel='stylesheet'>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link id="theme-style" rel="stylesheet" href="timeframe.css">

    <!-- MDB -->
    <link rel="stylesheet" href="css/mdb.min.css" />

    <link rel="icon" href="img/logo.png" type="image/x-icon" />

    <!-- for the logos in the sidebar -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">



    <title>Help Desk Dates</title>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <link href='https://fonts.googleapis.com/css?family=Oswald:300' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Familjen Grotesk' rel='stylesheet'>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

</head>




<body class="Site" id="index">
    <main>
        <div class="conterer">


            <!-- Start profil icons  -->
            <div class="action" style="z-index: 99999; font-size: 14px;">
                <div class=" profile" onclick="menuToggle();">

                    <img src="img/user.png"  />

                </div>

                <div class="menu">

                    <ul>

                        <li>


                            <img src="img/logout.png" /><a href="#" class="logout">Log Out</a>


                        </li>

                        <li>

                            <img src="img/lock.png" /><a href="resetinner.html">Reset Password</a>

                        </li>

                    </ul>

                </div>

            </div>
            <!-- end profil icons  -->




            <form style="margin-top: 1.5%;">
                <div class="contenr">
                    <!-- class="d-flex align-items-center justify-content-center" -->
                    <div class="row">

                        <div id="parent-deem">
                            <div class="col">
                                <div id="selection-deem">
                                    <div>
                                        <label>Please choose a semester</label><br><br>
                                        <div id="deem-menu">
                                            <select id="selectsemester" class="sem">
                                                <option value="default" selected disabled>Choose a semester
                                                </option>
                                            </select>
                                        </div><br>
                                        <!-- <input type="button" id="next" value="next"
                                            class="button-next-Deem"><br><br> -->
                                        <button type="button" id="next" value="next"
                                            class="button btn btn-primary btn-lg"
                                            style="padding: 6px 12px; font-size: medium;">Next</button><br><br>
                                    </div>

                                    <!-- <button id="next" value="next">next</button> -->
                                </div>
                            </div>


                            <div id="add-update-timeframe" style="display: none; ">
                                <div style="display: none;" class="card border-success mt-5 m-3 p-2 text-success"
                                    id="message"></div>
                                <div id="Mycontent">
                                    <label>choose a start date</label><br>
                                    <input type="date" id="start-date"><br>
                                    <label>choose an end date</label><br>
                                    <input type="date" id="end-date"><br>
                                    <div class="text-center d-inline-flex">
                                        <!-- <input type="button" id="add" value="add" style="display: none;"> -->
                                        <button type="button" id="add" value="add" class="button btn btn-primary btn-lg"
                                            style="display: none; margin-left: 4%; margin-top: 3%; padding: 6px 12px; font-size: medium;">Add</button>
                                        <!-- <input type="button" id="update" value="update" style="display: none;"> -->
                                        <button type="button" id="update" value="update"
                                            class="button btn btn-primary btn-lg"
                                            style="display: none;  margin-left: 4%;  margin-top: 3%; padding: 6px 12px; font-size: medium;">Update</button>
                                        <button type="button" id="cancle" value="cancle"
                                            class="btn btn-secondary text-white" onclick='Confirm();'
                                            style="display: none;  margin-left: 1%;  margin-top: 3%; padding: 6px 12px; font-size: medium; background-image: linear-gradient( #6C757D 0%, #6C757D 100%);">Cancle</button><br>
                                    </div>
                                </div>
                            </div>

                            <div id="show-past-dates" style="display: none; ">
                                <label>start date</label><br>
                                <pre id="stord-start"></pre>
                                <hr>
                                <label>end date</label><br>
                                <pre id="stord-end"></pre>

                                <!-- <input type="button" id="ok" value="ok" style="display: none;"> -->
                                <button type="button" id="ok" value="ok" class="button btn btn-primary btn-lg"
                                    style="display: none;  margin-left: 39%;">Ok</button><br><br>

                            </div>
                        </div>
                    </div>
                </div>
            </form>



            <!-- Start side Mnue  -->


            <nav class="sidebar ">


                <img class="logo" src="img/logo.png" alt="logo brand" height="10%" width="50%">
                <a href="index.html" accesskey="h"><i class="fa fa-fw fa-home"></i>Home</a>
                <a href="semesters.html" accesskey="s"><i class="fa fa-calendar"></i> Semesters</a>
                <a href="faculty.html" accesskey="m"><i class="fa fa-group"></i> Faculty Members Speciality </a>
                <a href="GPCategory.html" accesskey="g"><i class="fa fa-graduation-cap"></i> Graduation Projects Category</a>
                <a href="timeframe.html" accesskey="p" class="active_semester"><i class="fa fa-clock-o"></i> Help Desk Dates</a>
                <footer class="footer_eClinic">
                    <p class="text-white text-justify position-absolute bottom-0 display-10"> Copyright &copy; All
                        Rights
                        Reserved to
                        King Saud University.Made by eClinic Teams</p>
                </footer>
            </nav>

            <!-- End side Mnue  -->

        </div>
    </main>






    <!-- MDB -->
    <script type="text/javascript" src="js/mdb.min.js"></script>
    <!-- Custom scripts -->
    <script type="text/javascript"></script>
    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
        integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.min.js"
        integrity="sha384-IDwe1+LCz02ROU9k972gdyvl+AESN10+x7tBKgc9I5HFtuNz0wWnPclzo6p9vxnk"
        crossorigin="anonymous"></script>

    <!-- 
    <script>
        $(document).ready(function () {
            bindEventToNavigation();
            showBreadCrumb(); //Show the breadcrumb when you arrive on the new page
        });

        function bindEventToNavigation() {
            $.each($("#navigation_links > li > a"), function (index, element) {
                $(element).click(function (event) {
                    breadcrumbStateSaver($(this).attr('href'), $(this).text());
                    showBreadCrumb();
                });
            });
        }

        function breadcrumbStateSaver(link, text) {
            if (typeof (Storage) != "undefined") {
                if (sessionStorage.breadcrumb) {
                    var breadcrumb = sessionStorage.breadcrumb;
                    sessionStorage.breadcrumb = breadcrumb + " >> <a href='" + link + "'>" + text + "</a>";
                } else {
                    sessionStorage.breadcrumb = "<a href='" + link + "'>" + text + "</a>";
                }
            }
        }
    </script> -->



    <script type="module">

        document.getElementById("ok").onclick = function () {
            window.location.replace("index.html");
        };


        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-app.js";

        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
        import { getFirestore, doc, collection, getDocs, getDoc, Timestamp, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-firestore.js";
        // Your web app's Firebase configuration
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-auth.js"; //import for authentication 
        const firebaseConfig = {
            apiKey: "AIzaSyD6JcSscRU6XaF3SaCF_U3ggXAFYUnKKq8",
            authDomain: "eclinic-d5dec.firebaseapp.com",
            projectId: "eclinic-d5dec",
            storageBucket: "eclinic-d5dec.appspot.com",
            messagingSenderId: "148819771062",
            appId: "1:148819771062:web:fda813cec9a70acf247017"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore()
        const auth = getAuth()



        //---------------------------get all elements i want------------------------

        let semesterSelect = document.getElementById("selectsemester");
        let divselect = document.getElementById("selection-deem");
        let nextbtn = document.getElementById("next");
        let divAddUpdate = document.getElementById("add-update-timeframe");
        let startDatecal = document.getElementById("start-date");
        let endDatecal = document.getElementById("end-date");
        let addbtn = document.getElementById("add");
        let updatebtn = document.getElementById("update");
        let showdatesdiv = document.getElementById("show-past-dates");
        let stordstart = document.getElementById("stord-start");
        let stordend = document.getElementById("stord-end");
        let okbtn = document.getElementById("ok");
        let canclebtn = document.getElementById("cancle");

        var start = 0;
        var end = 0;

        let day = "";
        let month = "";
        let year = "";
        let day2 = "";
        let month2 = "";
        let year2 = "";
        let dateString = "";
        let dateString2 = "";

        //-------------------------------get the semesters and add them in the drop down menu-------------------
        async function getSemesters() {
            const querySnapshot = await getDocs(collection(db, "semester"));
            querySnapshot.forEach((doc) => { //loop for all doc in the collection
                // doc.data() is never undefined for query doc snapshots
                var option = document.createElement("option");
                option.text = doc.data().semestername;
                option.value = doc.id;
                semesterSelect.add(option);

            });
        }
        semesterSelect.addEventListener("change", function () { // if the admin choose another semester the add-update disaper
            divAddUpdate.style.display = "none";
            showdatesdiv.style.display = "none";
            addbtn.style.display = "none";
            updatebtn.style.display = "none";
            canclebtn.style.display = "none";
            divselect.style.marginLeft = "50%";
        })
        //--------------------------call the getSemesters function onload of the page -----------------------------------
        window.onload = function () {
            getSemesters();

        };

        //-----------------after choosing the semester we should check if she already added the time frame befor or not -----------
        async function CheckChosenSemester() {
            startDatecal.value = null; //if the admin choose a semester that has a start/end date 
            endDatecal.value = null;   //then go back for one that dose not have we delet the old data

            var inputID = null;
            inputID = semesterSelect.value;
            // alert(inputID);
            if (inputID == 'default')  // if the admin did not choose a semester
                alert("Please choose a semester");
            else { // if the admin chooses a semester
                //---------------fix the style----------------
                divselect.style.marginLeft = "35%";
                divAddUpdate.style.marginLeft = "-26%";
                divAddUpdate.style.marginTop = "9.3%";
                divAddUpdate.style.marginRight = "4%";
                divAddUpdate.style.height = "56%";
                divselect.style.height = "55%";
                divselect.style.width = "30%";

                //-----------end of fis the style--------------



                const docRef = doc(db, "semester", inputID); // get the doc with the id we took from the option value for firestore
                const docSnap = await getDoc(docRef);//get the info of the doc?


                if (docSnap.data().startdate == null) {//this semester does not have a timeftame
                    document.getElementById("Mycontent").style.display = "block";
                    addbtn.style.display = "block";
                    canclebtn.style.display = "block";
                    divAddUpdate.style.display = "block";
                    showdatesdiv.style.display = "none";
                    okbtn.style.display = "none";
                } else {// if the semester had time frame

                    if (new Date(docSnap.data().enddate.toDate()) < new Date()) {//ckeck if the semester in the past only show whit out add\update
                        showdatesdiv.style.display = "block";
                        showdatesdiv.style.marginLeft = "-26%";
                        showdatesdiv.style.marginTop = "9.3%";
                        showdatesdiv.style.marginRight = "4%";
                        showdatesdiv.style.height = "56%";
                        okbtn.style.display = "block";
                        let startDateMillSec = docSnap.data().startdate.toDate();//to get an js date obj  
                        let startdateobj = new Date(startDateMillSec);
                        day = startdateobj.getDate();
                        month = startdateobj.getMonth() + 1; //jan 0 not 1
                        year = startdateobj.getFullYear();
                        dateString = day + "-" + month + "-" + year;// to match the format yyy-mm-dd

                        stordstart.innerHTML = dateString;

                        let endDateMillSec = docSnap.data().enddate.toDate();//to get an js date obj  
                        let endDateobj = new Date(endDateMillSec);
                        day2 = endDateobj.getDate();
                        month2 = endDateobj.getMonth() + 1; //jan 0 not 1
                        year2 = endDateobj.getFullYear();
                        dateString2 = day2 + "-" + month2 + "-" + year2;

                        stordend.innerHTML = dateString2;
                    } else {//if the semester did not end
                        document.getElementById("Mycontent").style.display = "block";
                        showdatesdiv.style.display = "none";
                        divAddUpdate.style.display = "block"; // to show the add/update section
                        updatebtn.style.display = "block";//we show the update btn
                        canclebtn.style.display = "block";
                        //in her we get the stord date in firestore and converted to js object and store show it in the input date value

                        // let startDateMillSec = docSnap.data().startdate.seconds * 1000;//get the date in milliseconds
                        let startDateMillSec = docSnap.data().startdate.toDate();//to get an js date obj  
                        let startdateobj = new Date(startDateMillSec);
                        day = startdateobj.getDate();
                        month = startdateobj.getMonth() + 1; //jan 0 not 1
                        year = startdateobj.getFullYear();
                        if (day < 10)//to add 0 at the beginning of the number to match the js format yyy-mm-dd
                            day = "0" + day;
                        if (month < 10)
                            month = "0" + month;
                        dateString = year + "-" + month + "-" + day;// to match the format yyy-mm-dd
                        startDatecal.value = dateString;

                        let endDateMillSec = docSnap.data().enddate.toDate();//to get an js date obj  
                        let endDateobj = new Date(endDateMillSec);
                        day2 = endDateobj.getDate();
                        month2 = endDateobj.getMonth() + 1; //jan 0 not 1
                        year2 = endDateobj.getFullYear();
                        if (day2 < 10)
                            day2 = "0" + day2;
                        if (month2 < 10)
                            month2 = "0" + month2;
                        dateString2 = year2 + "-" + month2 + "-" + day2;
                        endDatecal.value = dateString2;

                        //var flag = false;
                    }

                }


            }

        }

        nextbtn.addEventListener("click", CheckChosenSemester);

        addbtn.addEventListener('click', async function () { //we wait entel the adimn click add
            const docRefadd = doc(db, "semester", semesterSelect.options[semesterSelect.selectedIndex].value); // get the doc with the id we took from the option value for firestore
            const docSnapadd = await getDoc(docRefadd);//get the info of the doc?
            start = startDatecal.value;
            end = endDatecal.value;
            var text = docSnapadd.data().semestername;
            var years = [];
            const myArray = text.split(" ");
            var flag = true;
            if (start == "" || end == "")//if the admin did not choose a start or end date
                alert("Please choose a start and an end date");
            else {//if the admin chooses a start and end dates
                var today = new Date();

                if (new Date(start).getDate() < today.getDate() && new Date(start).getMonth() <= today.getMonth() && new Date(start).getFullYear() <= today.getFullYear()) {//alert if the start date in the past
                    alert("Please choose dates that is in the future");
                    flag = false;
                } else if (start >= end) {
                    alert("Please choose a start day that is before the end date");
                    flag = false;
                } else if (myArray[1].length == 9) {
                    years = myArray[1].split("/");

                    if ((new Date(start).getFullYear() != years[0] && new Date(start).getFullYear() != years[1]) || (new Date(end).getFullYear() != years[0] && new Date(end).getFullYear() != years[1])) {
                        alert("chosen dates must be in the same year of the chosen semester");
                        flag = false;
                    }


                } else if (myArray[1].length == 4) {
                    years = myArray[1];
                    if (new Date(start).getFullYear() != years || new Date(end).getFullYear() != years) {
                        alert("chosen dates must be in the same year of the chosen semester");
                        flag = false;
                    }


                }
                if (flag) {

                    await updateDoc(docRefadd, { // we add the new time to a smester that dosenot have a time frame
                        startdate: Timestamp.fromDate(new Date(start + "T00:00:00")),
                        enddate: Timestamp.fromDate(new Date(end + "T23:59:59")),
                        // timeframe: true

                    });
                    // alert("Your work has been added successfully")
                    // window.location.replace("index.html");
                    successMessage('Dates has been added successfully.');
                }
            }
        })

        updatebtn.addEventListener('click', async function () { //we wait entel the adimn click update

            const docRefup = doc(db, "semester", semesterSelect.options[semesterSelect.selectedIndex].value); // get the doc with the id we took from the option value for firestore
            const docSnapup = await getDoc(docRefup);//get the info of the doc?
            start = startDatecal.value;
            end = endDatecal.value;
            var today = new Date();
            var todayM = today.getMonth() + 1;

            var text = docSnapup.data().semestername;
            var years = [];
            const myArray = text.split(" ");
            var flag = true;

            if (day <= today.getDate() && month <= todayM && year <= today.getFullYear() && start != dateString) {
                alert("Start date connot be changed for a date that has been reached");
                flag = false;
            } else if (new Date(start).getDate() < today.getDate() && new Date(start).getMonth() <= today.getMonth() && new Date(start).getFullYear() <= today.getFullYear() && start != dateString) {//alert if the start date in the past
                alert("Please choose a starting day in the future");
                flag = false;
            } else if (start >= end) {
                alert("Please choose a start day that is before the end date");
                flag = false;
            } else if (start == dateString && end == dateString2) {
                alert("You did not change the start date or the end date");
                flag = false;
            } else if (myArray[1].length == 9) {
                years = myArray[1].split("/");

                if ((new Date(start).getFullYear() != years[0] && new Date(start).getFullYear() != years[1]) || (new Date(end).getFullYear() != years[0] && new Date(end).getFullYear() != years[1])) {
                    alert("chosen dates must be in the same year of the chosen semester");
                    flag = false;
                }


            } else if (myArray[1].length == 4) {
                years = myArray[1];
                if (new Date(start).getFullYear() != years || new Date(end).getFullYear() != years) {
                    alert("chosen dates must be in the same year of the chosen semester2");
                    flag = false;
                }


            }
            if (flag) {

                await updateDoc(docRefup, { // we update the time to a smester 
                    startdate: Timestamp.fromDate(new Date(start + "T00:00:00")),
                    enddate: Timestamp.fromDate(new Date(end + "T23:59:59")),
                    // timeframe: true
                });

                // alert("Your work has been updated successfully");
                // window.location.replace("index.html");
                successMessage('Dates has been updated successfully.');
            }
        })

        //////////////////////////Authentication between pages/////////////////////////
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("the same user")
            }
            else {
                signOut(auth)
                window.location.replace("login.html")
                    .then(() => {
                        //console.log("user log out")
                    })
                    .catch((err) => {
                        console.log(err.message)
                    })
            }
            console.log("the user status change :", user)
        })



        /////////////////////////////log out ///////////////////////////////////////
        const logout = document.querySelector('.logout')
        logout.addEventListener("click", () => {
            const conf = confirm("Are you sure you want to log out?")

            if (conf === true) {
                signOut(auth)
                    .then(() => {
                        //console.log("user log out")
                    })
                    .catch((err) => {
                        console.log(err.message)
                    })

                window.location.replace("login.html")
            }


        });



        function successMessage(message) {
            document.getElementById("Mycontent").style.display = "none";
            addbtn.style.display = "none";
            updatebtn.style.display = "none";
            canclebtn.style.display = "none";



            document.getElementById('message').innerHTML = message;
            document.getElementById('message').style.display = "block";

            setTimeout(() => {
                var elems = document.querySelectorAll("tr.table-success");

                [].forEach.call(elems, function (el) {
                    el.classList.remove("table-success");
                });
                semesterSelect.value = "default";
                document.getElementById('message').style.display = "none";

                divAddUpdate.style.display = "none";
                showdatesdiv.style.display = "none";
                divselect.style.marginLeft = "50%";
            }, 4000);
        }



    </script>
    <script>
        // start: java sript for profile icons 
        function menuToggle() {
            const toggleMenu = document.querySelector(".menu");
            toggleMenu.classList.toggle("active");
        }
        // End: java sript for profile icons
    </script>

    <script type="text/javascript">
        function Confirm() {
            //put this in the link  onclick='Confirm();'

            // alert(document.getElementById("add-update-timeframe").style.display == 'block');

            if (confirm("Are you sure to want to cancle your work?") == true) {
                document.getElementById("selectsemester").value = "default";
                document.getElementById("add-update-timeframe").style.display = "none";
                document.getElementById("show-past-dates").style.display = "none";
                document.getElementById("add").style.display = "none";
                document.getElementById("update").style.display = "none";
                document.getElementById("cancle").style.display = "none";
                document.getElementById("selection-deem").style.marginLeft = "50%";
            }
            else
                return false;

        }
    </script>
</body>

</html>